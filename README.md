# CAESIUM
[![License](http://img.shields.io/:license-mit-blue.svg?style=flat-square)](https://github.com/frklan/caesium/blob/master/LICENSE)

**N.B. Very much in Alpha mode -- beware of bugs and unexpected behaviour.**

A Rest API to control Ikea Tr책dfri Lightbulbs. Pretty basic and probably unsecure. Make sure you understand the risks exposing the API to the world.

# Using the API

## Prerequisites

Make sure you have:

* NodeJS
* Ikea Tr책dfi Lightbulb
* Ikea Tr책dfri Gateway

## Installation

1. Clone the repository ````$ git clone git@github.com:frklan/caesium.git````

2. Install dependecies with ````$ npm install ````

3. Create an .env file in the root of the project containing:

		GW_PASSWORD=<Password as printed on your Tr책fri gateway>
		JWT_SECRET=<jwt secret>
		OTP_SECRET=<otp secret>

	*Please refer to below instructions how to generate thje JWT\_SECRET and OTP\_SECRET*

	Alternatively you can set the corresponding environment variables using your preferred method.

4. Run ```$ npm run start```

Access the API on port 5000 (or set a port in the .env file: ````PORT=<port number>````)

## JWT_SECRET 

The JWT_SECRET can be generated by any means, it should be a 32 character cryptographically strong random string, store it either in:

a. the .env file in the root of the project as
		
	JWT_SECRET=<secret string>

b. the $JWT_SECRET environment variable, e.g.:

		$ export JWT_SECRET=<secret string>


## OTP_SECRET 

The JWT token can be requested from API endpoint ````/login````, this reqiures an OTP password generated by eihter an 2FA app (e.g. google authenticator) or an 2FA library. The OTP secret is generated by the ````$  src/util/generateOtpSecret``` command. This will output both the secret text string as well as an QR code that can be scanned by a 2FA app. Store the secret code it either in:

a. the .env file in the root of the project as

	OTP_SECRET=<opt secret>
	
b. the $OTP_SECRET environment variable, e.g.:
 
	$ export OTP_SECRET=<secret string>
	

Acessing the /login API endpoint with header variables ````id```` and ````otp```` will return a JWT token that shall be used in any further access to the API:


	$ curl http://localhost:5000/login -X POST -H "id: caesium_api_user" -H "otp: 349721" 

			{ 
				"success":true,
				"token":"eyJhbGciOiJIUz....WTlOioJg_0zIjKZnB-txLqbT4A"
			}


## Manually generating a JWT token

A JWT token kan be manually generated with the following sequence:

1. run ````$  src/util/generateJwtToken```, the output will be similar to:
		src/util/generateJwtToken
		ID: caesium_api_user
		TTL: 3600
		Extra data: <not set>
		JWT token: eyJhbGciOiJIUz....WTlOioJg_0zIjKZnB-txLqbT4A

2. Set the header field ````token``` to the JWT token displayed when using the API endpoint, e.g.:
		
		$ curl http://localhost:5000/api/v1/bulbs -H "token: eyJhbGciOiJIUz....WTlOioJg_0zIjKZnB-txLqbT4A"


**Note** that the JWT token will defult expire in 3600 seconds. A longer (or shorter) expiration time can be set with the option --ttl, refer to ````$  src/util/generateJwtToken --help``` for details. There is no way of invalidating JWT tokens unless it expires automatically, hence it is important to treat them as secrets.


# API endpoints

### POST login

	$ curl http://localhost:5000/login -X POST -H "id: caesium_api_user" -H "otp: 349721" 

Response:

		{ 
			"success":true,
			"token":"eyJhbGciOiJIUz....WTlOioJg_0zIjKZnB-txLqbT4A"
		}


### GET api/v1/bulbs
Lists current known bulbs and states

Example:

	$ curl http://localhost:5000/api/v1/bulbs -X GET -H "token: eyJhbGciOiJIUz....WTlOioJg_0zIjKZnB-txLqbT4A"
	
Response:

	  [
	    {
	      "name": "Table",
	      "id": 65540,
	      "light": {
	          "onOff": false,
	          "dimmer": 17.3,
	          "color": "f1e0b5",
	          "colorTemperature": 58.8,
	          "colorX": 30138,
	          "colorY": 26909,
	          "transitionTime": 0.5
	        }
	    },
	    {
	        "name": "Window",
	        "id": 65541,
	        "light": {
	            "onOff": true,
	            "dimmer": 7.9,
	            "color": "efd275",
	            "colorTemperature": 100,
	            "colorX": 30138,
	            "colorY": 26909,
	            "transitionTime": 0.5
	        }
	    }
	  ]

### GET api/v1/bulb/[bulb id]
Report state on a single bulb

Example:

	$ curl http://localhost:5000/api/v1/bulb/65530 -X GET -H "token: eyJhbGciOiJIUz....WTlOioJg_0zIjKZnB-txLqbT4A"
	
Response:

		[
		    {
		        "name": "Table",
		        "id": 65530,
		        "light": {
		            "onOff": false,
		            "dimmer": 17.3,
		            "color": "f1e0b5",
		            "colorTemperature": 58.8,
		            "colorX": 30138,
		            "colorY": 26909,
		            "transitionTime": 0.5
		        }
		    }
		]



### POST api/v1/bulb/[bulb id]/toggle
Toggles a bulb on or off

Example:

		$ curl http://localhost:5000/api/v1/bulb/65530/toggle -X POST -H "token: eyJhbGciOiJIUz....WTlOioJg_0zIjKZnB-txLqbT4A"


Response:

	  "{status: done}"

### POST api/v1/bulb/[bulb id]/[ON] || [OFF]
Switches a bulb on or off. 

Example:

		$ curl http://localhost:5000/api/v1/bulb/65530/ON -X POST -H "token: eyJhbGciOiJIUz....WTlOioJg_0zIjKZnB-txLqbT4A"

Response:

	  "{status: done}"


# TODO's

- [X] Basic authorization check before granting aceess to the API 
  
# Contributing

Contributions are always welcome!

When contributing to this repository, please first discuss the change you wish to make via the issue tracker, email, or any other method with the owner of this repository before making a change.

Please note that we have a code of conduct, you are required to follow it in all your interactions with the project.

# Versioning

We use [SemVer](http://semver.org/) for versioning. For the versions available, see the [tags on this repository](https://github.com/frklan/caesium/tags).

# Authors

* **Fredrik Andersson** - *Initial work* - [frklan](https://github.com/frklan)

# License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details